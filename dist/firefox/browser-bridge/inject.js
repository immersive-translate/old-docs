(()=>{var u={BUILD_TIME:"2024-10-30T09:05:33.000Z",VERSION:"1.22.7",PROD:"1",PROD_API:"1",BETA:"0",userscript_domains:'["google.com","translate.googleapis.com","api-edge.cognitive.microsofttranslator.com","edge.microsoft.com","transmart.qq.com","translate.yandex.net","tmt.tencentcloudapi.com","www2.deepl.com","w.deepl.com","immersive-translate.owenyoung.com","generativelanguage.googleapis.com","chat.openai.com","bing.com","www.bing.com","open.volcengineapi.com","fanyi.baidu.com","api.fanyi.baidu.com","api.interpreter.caiyunai.com","api-free.deepl.com","api.deepl.com","api.openl.club","openapi.youdao.com","translate.volcengine.com","api.niutrans.com","immersivetranslate.com","test-api2.immersivetranslate.com","api2.immersivetranslate.com","config.immersivetranslate.com","app.immersivetranslate.com","dash.immersivetranslate.com","api.immersivetranslate.com","immersive-translate.deno.dev","www.googleapis.com","www.google-analytics.com","translate-pa.googleapis.com","api.cognitive.microsofttranslator.com","api.groq.com","api.x.ai","api.papago-chrome.com","api.openai.com","api.interpreter.caiyunai.com","api.cognitive.microsofttranslator.com","aidemo.youdao.com","dict.youdao.com","openai.azure.com","mt.aliyuncs.com","subhub.weixin.so","api.anthropic.com","localhost","127.0.0.1","ai.immersivetranslate.com","test-ai.immersivetranslate.com","openrouter.ai","dashscope.aliyuncs.com","api.deepseek.com","aip.baidubce.com","ark.cn-beijing.volces.com","hunyuan.tencentcloudapi.com","public-beta-api.siliconflow.cn","api.siliconflow.cn","open.bigmodel.cn","store.immersivetranslate.com","qianfan.baidubce.com"]',INSTALL_FROM:"firefox_zip",LOCAL_HTTPS:"0",MOCK:"0",DEBUG:"0",IMMERSIVE_TRANSLATE_FIREFOX:"1"};function m(){return typeof process>"u"&&typeof Deno<"u"?Deno.env.toObject():u}var me=m();function pe(){return typeof location>"u"?!1:location.href.includes("side-panel")&&location.href.includes("extension://")}function x(t,e){return!e&&pe()?!0:t&&globalThis?.document?.querySelector("meta[name=immersive-translate-options]")?!!globalThis.document?.getElementById("immersive-translate-manifest")?.value?.includes("_isUserscript"):me.IMMERSIVE_TRANSLATE_USERSCRIPT==="1"}var we=m().PROD==="1",O=m().PROD!=="1";var fe="";function h(){return fe||globalThis.navigator.userAgent}function S(){let t=h();return t.includes("ImtFxiOS")||t.includes("ImtiOS")}function v(){let t=h();return t.includes("ImtFxAndroid")||t.includes("ImtFxAOS")}function N(){if(!v())return!1;let t=h();return t.endsWith("official_cn")||t.includes("mainlandStore")}function k(){return S()?h().includes("mainland"):!1}var E=class{bridge;waitForBridge(e=1e4){return!v()&&!S()&&!he()?Promise.resolve(!1):globalThis.WebViewJavascriptBridge?(this.bridge=globalThis.WebViewJavascriptBridge,Promise.resolve(!0)):new Promise(n=>{let o=Date.now(),a=()=>{if(globalThis.WebViewJavascriptBridge)return this.bridge=globalThis.WebViewJavascriptBridge,n(!0);if(Date.now()-o>e)return n(!1);requestAnimationFrame(a)};a()})}registerHandler(e,n){this.bridge&&this.bridge.registerHandler(e,n)}callHandler(e,n,o){this.bridge&&this.bridge.doSend({type:e,...n},o)}},s=new E;function he(){return O?window.location.href.endsWith("browser.html"):!1}var M="DENO",y="CHROME",I="FIREFOX";function ye(t){let e;try{let n=navigator?.userAgent||"";/firefox/i.test(n)||typeof InstallTrigger<"u"?e=I:/deno/i.test(n)?e=M:/chrome/i.test(n)&&(e=y)}catch{}return t===y&&e===y||t===I&&e===I||t===M&&e===M}function L(t=!1){let e=m();return N()||k()||!t&&e.region_plugin=="mainland"?!0:ye(y)&&e.IMMERSIVE_TRANSLATE_CN_CHROME==="1"}var r="immersiveTranslate";var l="immersive-translate",U="imt";var tt=r+"DeeplGlobalState",nt=r+"BingGlobalState",rt=r+"YandexGlobalState",ot=r+"BaiduQianfanGlobalConfigStorageKey",at=r+"SiliconCloudGlobalConfigStorageKey",st=r+"IMT_TRANSLATION_COMMON_TOKEN",it=r+"ZhipuGlobalConfigStorageKey";var lt=r+"GoogleAccessToken",ct=r+"AuthFlow",ut=l+"-config-latest.json",dt=r+"AuthState",gt=r+"IframeMessage",mt=r+"WaitForRateLimit",pt=r+"DocumentMessageAsk",A=r+"DocumentMessageTellThirdParty",ft=r+"showError",ht=r+"showModal",yt=r+"showDialog",Tt=r+"showToast",bt=r+"tokenUsageChange",D=r+"DocumentMessageThirdPartyTell",xt=r+"DocumentMessageEventUpload",St=r+"DocumentMessageTypeStopJsSDK",vt=r+"DocumentMessageHandler",Et=r+"DocumentSetFloatBallActive",Mt=`${r}Share`,It=`${r}ShowFloatBallGuide`,At=`${r}ShowPopupModalGuide`,Pt=r+"DocumentMessageTempEnableSubtitleChanged",Ct=r+"DocumentMessageUpdateQuickButtonAiSubtitle",_t=`${r}ToggleMouseHoverTranslateDirectly`,wt=`${r}ReqDraft`,Rt=`${r}ResDraft`,Bt=`${r}Container`,Ot=`${r}SpecifiedContainer`;var Nt=`${r}PageTranslatedStatus`,kt=`${r}MangaTranslatedStatus`,Lt=`${r}PageUrlChanged`,Ut=`${r}ReceiveCommand`,Dt=r+"LastUseMouseHoverTime",Ft=r+"LastUseInputTime",Ht=r+"LastUseManualTranslatePageTime",Wt=`${r}PopupReceiveMessage`,Gt=`${r}SidePanelReceiveMessage`,$t=r+"DocumentMessageEventTogglePopup",Kt=`${r}Mark`,Vt=`${r}Root`,qt=`${r}Walked`,Jt=`data-${l}-walked`,jt=`${r}Paragraph`,Yt=`data-${l}-paragraph`,zt=`data-${l}-translation-element-mark`,Xt=`${r}TranslationElementMark`,Qt=`${r}TranslatedMark`,Zt=`${l}-input-injected-css`,en=`${r}LoadingId`,tn=`data-${l}-loading-id`,nn=`${r}ErrorId`,rn=`data-${l}-error-id`,on=`${r}AtomicBlockMark`,an=`${r}ExcludeMark`,sn=`data-${l}-exclude-mark`,ln=`${r}StayOriginalMark`,cn=`${r}PreWhitespaceMark`,un=`${r}InlineMark`,dn=`${r}BlockMark`,gn=`${r}Left`,mn=`${r}Right`,pn=`${r}Width`,fn=`${r}Height`,hn=`${r}Top`,yn=`${r}FontSize`;var Tn=`${r}GlobalStyleMark`;var bn=`${l}-target-wrapper`,xn=`${l}-pdf-target-container`,Sn=`${l}-target-inner`,vn=`${l}-source-wrapper`,En=`${l}-target-translation-block-wrapper`,Mn=`${l}-root-translation-theme`,In=`${r}RootTranslationTheme`,An=`${l}-target-translation-vertical-block-wrapper`,Pn=`${l}-target-translation-pdf-block-wrapper`,Cn=`${l}-target-translation-pre-whitespace`,_n=`${l}-target-translation-inline-wrapper`;var wn=[{name:"touch",shortcuts:[{command:"touchShortcutsToggleTranslatePage",type:"finger"},{command:"touchShortcutsToggleTranslationMask",type:"finger"},{command:"touchShortcutsToggleTranslatePageOnlyTranslation",type:"finger"},{command:"touchShortcutsToggleTranslateTouchElement",type:"finger"},{command:"touchShortcutsInputTranslate",type:"finger"}]},{name:"main",shortcuts:["toggleTranslatePage","shareToDraft","translateInputBox","toggleSidePanel","openAiWritingModal"]},{name:"mouse",shortcuts:[{command:"mouseHoverHoldKey",type:"mouseHoverHoldKey"},"toggleMouseHoverTranslateDirectly"]},{name:"others",shortcuts:["toggleTranslationMask","toggleTranslateToThePageEndImmediately","toggleTranslateTheMainPage","toggleOnlyTransation","toggleTranslateTheWholePage","toggleVideoSubtitlePreTranslation"]},{name:"shortcutsForTranslationServices",shortcuts:L()?[{command:"translateWithCustom1",type:"translateWithCustom"},{command:"translateWithCustom2",type:"translateWithCustom"},{command:"translateWithCustom3",type:"translateWithCustom"}]:["translateWithDeepL","translateWithGoogle","translateWithOpenAI","translateWithBing","translateWithTransmart","translateWithGemini","translateWithClaude",{command:"translateWithCustom1",type:"translateWithCustom"},{command:"translateWithCustom2",type:"translateWithCustom"},{command:"translateWithCustom3",type:"translateWithCustom"}]}];var Rn={type:r+"ChildFrameToRootFrameIdentifier"};var Bn=50*1e4,On=`[${U}-ctx-divider]`,Nn=`${U}_context_preview`;var kn=`${r}_selection_update_params`,Ln=`data-${l}-subtitle-type`,Un=`data-${l}-ai-subtitle-url`,Dn=`data-${l}-has-subtitle`;var Te=["google","bing","zhipu","siliconcloud","transmart","yandex"],be=["deepseek","openai","claude","gemini","zhipu-pro","deepl"],xe=["openai","claude","gemini"],Fn=[...Te,...be,...xe];var Hn=l+"-large-cache";var P=class{constructor(){}getRandomId(){return(new Date().getTime()+Math.random())*Math.random()}sendAsyncMessages({type:e,data:n}){return new Promise(o=>{let a=this.getRandomId(),i=this.handleMessage(e,d=>{d.id===a&&(i(),o(d.payload))});this.sendMessages({type:e,id:a,data:n})})}sendMessages(e){globalThis.document.dispatchEvent(new CustomEvent(D,{detail:JSON.stringify({id:e.id||this.getRandomId(),type:e.type,data:e.data})}))}handleMessages(e){let n=o=>{let a=o;if(a.detail)try{let i=JSON.parse(a.detail);e(i)}catch{}};return globalThis.document.addEventListener(A,n),()=>{globalThis.document.removeEventListener(A,n)}}handleMessage(e,n){return this.handleMessages(o=>{o.type===e&&n(o)})}},Se=new P,ve={get(t,e,n){return e in t?(...o)=>{let a=t[e];return typeof a=="function"?a.apply(t,o):Reflect.get(t,e,n)}:o=>{if(e.startsWith("getAsync")||e.endsWith("Async"))return t.sendAsyncMessages({type:e,data:o});t.sendMessages({type:e,data:o})}}},c=new Proxy(Se,ve);function F(t,e){let n="right: unset; bottom: unset; left: 50%; top: 0; transform: translateX(-50%);";globalThis.innerWidth>450&&(n="left: unset; top: 0; right: 20px; bottom: unset; transform: none;"),c.togglePopup({style:t.style||n,isSheet:t.isSheet||!1,overlayStyle:t.overlayStyle||"background-color: transparent;"}),e({result:!0})}function H(t,e){let n="right: unset; bottom: unset; left: 50%; top: 0; transform: translateX(-50%);";globalThis.innerWidth>450&&(n="left: unset; top: 0; right: 20px; bottom: unset; transform: none;"),c.openPopup({style:t.style||n,isSheet:t.isSheet||!1,overlayStyle:t.overlayStyle||"background-color: transparent;"}),e({result:!0})}function W(t,e){c.closePopup(),e({result:!0})}function G(t,e){c.translatePage(),e({result:!0})}function $(t,e){c.restorePage(),e({result:!0})}async function K(t,e){let n=await c.getPageStatusAsync();e({result:!0,status:n,pageTranslated:n=="Translated"})}function V(t,e){c.openImageTranslationFeedback(),e({result:!0})}function q(t,e){c.openWebTranslationFeedback(),e({result:!0})}async function J(t,e){let n=await c.getAsyncTranslationServiceList();e({result:!0,data:JSON.stringify(n)})}async function j(t,e){let n=await c.setMiniConfigAsync(t);e({result:!0,data:JSON.stringify(n)})}async function Y(t,e){let n=await c.updateUserConfigAsync(t);e({result:!0,data:JSON.stringify(n)})}async function z(t,e){let n=await c.switchTranslationMode(t);e({result:!0,data:JSON.stringify(n)})}async function X(t,e){let n=await c.updateTranslationThemeConfig(t);e({result:!0,data:JSON.stringify(n)})}async function Q(t,e){let n=await c.getAsyncLanguageByText(t||"");e({result:!0,data:n})}async function Z(t,e){await c.requestTermsContextByServices(t),e({result:!0})}async function ee(t,e){t.serviceConfig={disableTokensRatioFallback:!0,disableAIMultipleFallback:!0,enableFallback:!1,...t.serviceConfig};let n=await c.getAsyncTranslateContent(t);if(!n.sentences){e({result:!1,error:n});return}e({result:!0,data:n.sentences})}async function te(t,e){let n=await c.getAllLanguageListAsync(t);e({result:!0,data:n})}async function ne(t,e){let n=await c.getMiniConfigAsync();e({result:!0,data:n})}async function re(t,e){await c.syncUserLoginSetting(),e({result:!0})}var T=[];function oe(t,e){try{let{imageUrl:n}=t;if(!_(n))return e({result:!1,errMsg:"\u56FE\u7247\u4E0D\u5B58\u5728"});w({originalUrl:n,triggerResultCallback:e}),c.triggerTranslateImageBySrc(n)}catch{e({result:!1,errMsg:"\u7FFB\u8BD1\u8FC7\u7A0B\u53D1\u751F\u9519\u8BEF"})}}function ae(t,e){let{imageId:n,imageUrl:o}=t,a="";if(o){let i=_(o);i||e({result:!1,errMsg:"\u627E\u4E0D\u5230\u539F\u56FE"}),a=i?.getAttribute("bak_src")||""}else{let i=p({urlHash:n});if(!i){e({result:!1,errMsg:"\u627E\u4E0D\u5230\u7FFB\u8BD1\u540E\u7684\u56FE"});return}if(!_(i.originalUrl)){e({result:!1,errMsg:"\u627E\u4E0D\u5230\u539F\u56FE"});return}a=i.originalUrl}c.cleanTranslateImageBySrc(a)}function se(t){let{urlHash:e,imgData:n,originalUrl:o}=t,a=p({originalUrl:o});a||(a={originalUrl:o,urlHash:e}),a.urlHash=e,w(a),C(e,{state:"extension_uploading",errorMsg:""}),s.callHandler("imageTextRecognition",{imageId:e,imageUrl:o,imageData:n},function(i){let{imageId:d,boxes:g,result:R,errMsg:B}=i;R&&g&&C(d,{state:"saved",errorMsg:"",result:{ocrTime:0,boxesWithText:g}}),!R&&B&&C(d,{state:"error",errorMsg:B})})}function ie(t){let{urlHash:e}=t,n=p({urlHash:e});if(!n)return;let o=n.imgState;return{urlHash:e,state:o}}function le(t){let{imgHash:e,originalUrl:n,ok:o,errMsg:a}=t,i=p({originalUrl:n});i&&(w(i),i.triggerResultCallback?.({result:o,errMsg:a}))}function w(t){let e=Ee(t);if(e!==-1){T[e]=t;return}T.push(t)}function C(t,e){let n=p({urlHash:t});n&&(n.imgState=e)}function Ee(t){return T.findIndex(e=>t.urlHash===e.urlHash||t.originalUrl===e.originalUrl)}function p(t){return T.find(e=>t.urlHash===e.urlHash||t.originalUrl===e.originalUrl)}function _(t){let e=document.querySelector(`img[src="${t}"]`)||document.querySelector(`img[bak_src="${t}"]`);if(e)return e;let n=document.querySelector(`[srcset*="${t}"]`)||document.querySelector(`[bak_srcset*="${t}"]`);return n instanceof HTMLSourceElement?n.parentElement?.querySelector("img"):n instanceof HTMLImageElement?n:n instanceof HTMLPictureElement?n.querySelector("img"):null}var f=class{from;to;constructor(e){this.from=e.from,this.to=e.to}sendMessages(e){let n={type:e.type,data:e.data,id:e.id||this.getRandomId(),isAsync:!1};globalThis.document.dispatchEvent(new CustomEvent(this.to,{detail:JSON.stringify(n)}))}getRandomId(){return Math.random()*1e17+new Date().getTime()}sendAsyncMessages({type:e,data:n}){return new Promise(o=>{let a=this.handleMessages(g=>{g.id===i&&(o(g.data),a())}),i=this.getRandomId(),d={type:e,data:n,id:i,isAsync:!0};globalThis.document.dispatchEvent(new CustomEvent(this.to,{detail:JSON.stringify(d)}))})}handleMessageOnce(e){return new Promise(n=>{let o=this.handleMessage(e,a=>{n(a.data),o()})})}handleMessage(e,n){return this.handleMessages(o=>{o.type===e&&n(o)})}handleMessages(e){let n=o=>{let i=JSON.parse(o.detail||"{}");i&&typeof i=="object"&&e(i)};return globalThis.document.addEventListener(this.from,n),()=>{globalThis.document.removeEventListener(this.from,n)}}},ce={get(t,e,n){return e in t?(...o)=>{let a=t[e];return typeof a=="function"?a.apply(t,o):Reflect.get(t,e,n)}:o=>t.sendAsyncMessages({type:e,data:o})}};var ue="imt-browser-bridge-event-to-content-script",de="imt-browser-bridge-event-to-inject",Me=new f({from:ue,to:de}),b=new f({from:de,to:ue}),Zn=new Proxy(Me,ce);async function Ie(){try{if(!await s.waitForBridge())return;s.registerHandler("translateImage",oe),s.registerHandler("restoreImage",ae),s.registerHandler("translatePage",G),s.registerHandler("restorePage",$),s.registerHandler("getPageStatus",K),s.registerHandler("togglePopup",F),s.registerHandler("openPopup",H),s.registerHandler("closePopup",W),s.registerHandler("getTranslationServiceList",J),s.registerHandler("setMiniConfig",j),s.registerHandler("updateUserConfig",Y),s.registerHandler("switchTranslationMode",z),s.registerHandler("updateTranslationThemeConfig",X),s.registerHandler("openImageTranslationFeedback",V),s.registerHandler("openWebTranslationFeedback",q),s.registerHandler("detectLanguage",Q),s.registerHandler("requestTermsContextByServices",Z),s.registerHandler("translateText",ee),s.registerHandler("getAllLanguageList",te),s.registerHandler("getMiniConfig",ne),s.registerHandler("syncUserLoginSetting",re),Ae(),b.sendMessages({type:"bridgeReady"})}catch{}}function Ae(){b.handleMessages(async t=>{try{let{type:e,data:n}=t,o=null;if(e==="triggerClientTranslateImage")se(n);else if(e==="queryImageTranslateState")o=ie(n);else if(e==="notifyClientImageTranslatedResult")le(n);else if(e==="getUserInfo")o=await Pe();else if(e==="getBaseInfo")o=await Ce();else if(e==="updatePageStatus")s.callHandler("updatePageStatus",n,a=>{});else return;b.sendMessages({type:e,id:t.id,data:o})}catch{}})}function Pe(){return new Promise(t=>{s.callHandler("getUserInfo",{},e=>{e.data?t(e.data):t(null)})})}function Ce(){return new Promise(t=>{s.callHandler("getBaseInfo",{},e=>{e.data?t(e.data):t(null)})})}x()||Ie();})();
