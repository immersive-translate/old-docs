(()=>{var f="imt-subtitle-inject",h=class{from;to;constructor(t,s){this.from=t,this.to=s}sendMessages(t){globalThis.postMessage({type:f,to:this.to,from:this.from,action:t.action,data:t.data,id:t.id||new Date().getTime(),isAsync:!1})}getRandomId(){return(new Date().getTime()+Math.random())*Math.random()}sendAsyncMessages({action:t,data:s}){return new Promise(e=>{let n=this.getRandomId();globalThis.postMessage({type:f,to:this.to,from:this.from,action:t,data:s,id:n,isAsync:!0});let a=({data:o})=>{f===o.type&&o.id===n&&o.to===this.from&&(e(o.data),globalThis.removeEventListener("message",a))};globalThis.addEventListener("message",a)})}handleMessageOnce(t){return new Promise(s=>{let e=({data:n})=>{f===n.type&&n.action===t&&n.to===this.from&&(s(n.data),globalThis.removeEventListener("message",e))};globalThis.addEventListener("message",e)})}handleMessage(t,s){let e=({data:n})=>{f===n.type&&n.action===t&&n.to===this.from&&s(n)};return globalThis.addEventListener("message",e),()=>{globalThis.removeEventListener("message",e)}}handleMessages(t){let s=({data:e})=>{f===e.type&&e.to===this.from&&t(e)};return globalThis.addEventListener("message",s),()=>{globalThis.removeEventListener("message",s)}}},q=new h("content-script","inject"),c=new h("inject","content-script"),M={get(r,t,s){return t in r?(...e)=>{let n=r[t];return typeof n=="function"?n.apply(r,e):Reflect.get(r,t,s)}:e=>r.sendAsyncMessages({action:t,data:e})}},v=new Proxy(c,M),I=new Proxy(q,M);function x(r){if(!r)return null;try{let t=r;return r.startsWith("//")?t=globalThis.location.protocol+r:r.startsWith("/")?t=`${globalThis.location.protocol}//${globalThis.location.host}${r}`:r.startsWith("http")||(t=`${globalThis.location.protocol}//${r}`),new URL(t).toString()}catch(t){return console.error(t),r}}var i=class{content=v;config;constructor(t){this.config=t,c.handleMessages(async({action:s,id:e,data:n})=>{let a=this[s];if(!a)return;let o=a.apply(this,[n]);o instanceof Promise&&(o=await o),c.sendMessages({id:e,data:o})})}triggerSubtitle(t){}async translateSubtitle(t){let s=await this.content.requestSubtitle({url:x(t._url)});if(s){if(this.config.responseType=="document"){let n=new DOMParser().parseFromString(s,"text/xml");Object.defineProperty(t,"responseXML",{value:n,writable:!1}),Object.defineProperty(t,"response",{value:n,writable:!1});return}let e=s;(t.responseType=="arraybuffer"||this.config.responseType=="arraybuffer")&&typeof s=="string"&&(e=new TextEncoder().encode(s).buffer),Object.defineProperty(t,"responseText",{value:e,writable:!1}),Object.defineProperty(t,"response",{value:e,writable:!1})}}async translateSubtitleWithFetch(t,s){let e={...s},n;return typeof t=="string"?n={url:t,method:"GET",headers:{}}:n=await L(t),e?.body&&(e.body=T(e.body)),this.content.requestSubtitle({fetchInfo:JSON.stringify({input:n,options:e})})}async getVideoMeta(t){}isSubtitleRequest(t){return!this.config||!this.config.subtitleUrlRegExp||!t?!1:new RegExp(this.config.subtitleUrlRegExp).test(t||"")}};function L(r){if(r instanceof URL)return{url:r.href,method:"GET",headers:{}};let t=r.clone(),s={url:r.url,method:r.method,headers:Object.fromEntries(r.headers.entries())};if(t.body){let e=T(t.body);if(t.body!==e)return t.text().then(n=>(s.body=n,s));s.body=e}return Promise.resolve(s)}function T(r){if(!r)return r;if(r instanceof FormData||r instanceof URLSearchParams){let t={};for(let[s,e]of r.entries())t[s]=e;return t._formatBodyType="FormData",t}return r}var g=class extends i{timer=null;triggerSubtitle({force:t}){setTimeout(()=>{if(this.config?.subtitleButtonSelector){let s=document.querySelector(this.config.subtitleButtonSelector);if(s){let e=s.getAttribute("aria-pressed")==="true";e&&t?(s.click(),setTimeout(()=>{s.click()},100)):e||s.click();return}}if(this.config?.videoPlayerSelector){let s=document.querySelector(this.config.videoPlayerSelector);s?.toggleSubtitles(),setTimeout(()=>{s?.toggleSubtitles()},100)}},1e3)}async getVideoMeta(){if(!this.config.videoPlayerSelector)return null;try{return await this.sleep(100),document.querySelector(this.config.videoPlayerSelector)?.getPlayerResponse()}catch{return null}}sleep(t){return new Promise(s=>{setTimeout(()=>{s(null)},t)})}};var m=class extends i{timer=null;videoMeta={};lastVideoMeta=null;constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=s=>{let e=t(s);try{e&&e.result&&e.result.timedtexttracks&&e.result.movieId&&(this.videoMeta[e.result.movieId]=e.result,this.lastVideoMeta=e.result)}catch(n){console.log(n)}return e}}getVideoMeta(t){return this.lastVideoMeta}};var d=class extends i{timer=null;videoMeta={};constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=s=>{let e=t(s);try{e?.asset?.captions?.length?this.videoMeta[e.id]=e?.asset:e?.previews&&e?.course&&e?.previews?.forEach(n=>{this.videoMeta[n.id]=n})}catch(n){console.error(n)}return e}}getVideoMeta(t){return this.videoMeta[t]}};var p=class extends i{timer=null;videoMeta={};constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=s=>{let e=t(s);try{if(e?.stream?.sources?.length&&e?.stream?.sources[0]?.complete?.url){let n=window.location.pathname.split("/");n.length>2&&n[n.length-2]==="video"&&(this.videoMeta[n[n.length-1]]=e.stream.sources[0].complete.url)}}catch(n){console.error(n)}return e}}getVideoMeta(t){return this.videoMeta[t]}};var y=class extends i{constructor(t){super(t)}async translateSubtitleWithFetch(t,s){this.main(t,s)}async main(t,s){let e=globalThis.__originalFetch;if(!e)return;let n=t;t instanceof Request&&(n=t.clone());let a=await e(n,s);if(!a.ok)return;let o=await a.json();o.transcripts_urls&&this.requestSubtitle(o.transcripts_urls)}async requestSubtitle(t){await u(),await this.content.requestSubtitle(t)}};var b=class extends i{constructor(t){super(t)}lang="";async translateSubtitleWithFetch(t,s){this.main(t,s)}async main(t,s){let e=globalThis.__originalFetch;if(!e)return;let n=this.getUrl(t);return/textstream_/.test(n)?this.parseLang(n):this.parseAllSubs(t,s,e)}getUrl(t){return t.toString()}async parseLang(t){let e=t.match(/textstream_(\w+)=/)?.[1];return!e||e==this.lang||(this.lang=e,await u(),this.content.changeLang(e)),null}async parseAllSubs(t,s,e){if(!e)return;let n=t;t instanceof Request&&(n=t.clone());let a=await e(n,s);if(!a.ok)return;let o=await a.json();o.text_track_urls&&this.requestSubtitle(o.text_track_urls)}async requestSubtitle(t){await u(),await this.content.requestSubtitle(t)}};var w={hookRequest:()=>{}};async function P(){let r=await c.sendAsyncMessages({action:"getConfig"});if(!r)return;let s={youtube:g,netflix:m,webvtt:i,khanacademy:i,udemy:d,general:i,ebutt:i,hulu:y,mubi:b,disneyplus:p,"fmp4.xml":i,multi_attach_vtt:i,twitter:i,subsrt:i,xml:i,text_track_dynamic:i,av:i}[r.type||""];if(!s)return;let e=new s(r);w.hookRequest(e,r)}w.hookRequest=(r,t)=>{if(t.hookType.includes("xhr")){let s=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send,n=function(){return this._url=arguments[1],s.apply(this,arguments)},a=async function(){return r.isSubtitleRequest(this._url)?(await u(),await r.translateSubtitle(this),e.apply(this,arguments)):e.apply(this,arguments)};Object.defineProperty(XMLHttpRequest.prototype,"open",{value:n,writable:!0}),Object.defineProperty(XMLHttpRequest.prototype,"send",{value:a,writable:!0})}if(t.hookType.includes("fetch")){let s=globalThis.fetch;globalThis.__originalFetch=s,globalThis.fetch=async function(e,n){let a=typeof e=="string"?e:e.url||e.href;if(!r.isSubtitleRequest(a))return s(e,n);await u();let R=await r.translateSubtitleWithFetch(e,n);return R?new Response(R):s(e,n)}}};var S=!1;async function u(){return S||(await c.handleMessageOnce("contentReady"),S=!0),S}u();P();})();
