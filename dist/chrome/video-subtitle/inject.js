(()=>{var u="imt-subtitle-inject",c=class{from;to;constructor(t,s){this.from=t,this.to=s}sendMessages(t){globalThis.postMessage({type:u,to:this.to,from:this.from,action:t.action,data:t.data,id:t.id||new Date().getTime(),isAsync:!1})}getRandomId(){return(new Date().getTime()+Math.random())*Math.random()}sendAsyncMessages({action:t,data:s}){return new Promise(e=>{let i=this.getRandomId();globalThis.postMessage({type:u,to:this.to,from:this.from,action:t,data:s,id:i,isAsync:!0});let o=({data:a})=>{u===a.type&&a.id===i&&a.to===this.from&&(e(a.data),globalThis.removeEventListener("message",o))};globalThis.addEventListener("message",o)})}handleMessageOnce(t){return new Promise(s=>{let e=({data:i})=>{u===i.type&&i.action===t&&i.to===this.from&&(s(i.data),globalThis.removeEventListener("message",e))};globalThis.addEventListener("message",e)})}handleMessage(t,s){let e=({data:i})=>{u===i.type&&i.action===t&&i.to===this.from&&s(i)};return globalThis.addEventListener("message",e),()=>{globalThis.removeEventListener("message",e)}}handleMessages(t){let s=({data:e})=>{u===e.type&&e.to===this.from&&t(e)};return globalThis.addEventListener("message",s),()=>{globalThis.removeEventListener("message",s)}}},M=new c("content-script","inject"),l=new c("inject","content-script"),p={get(n,t,s){return t in n?(...e)=>{let i=n[t];return typeof i=="function"?i.apply(n,e):Reflect.get(n,t,s)}:e=>n.sendAsyncMessages({action:t,data:e})}},S=new Proxy(l,p),T=new Proxy(M,p);var r=class{content=S;config;constructor(t){this.config=t,l.handleMessages(async({action:s,id:e,data:i})=>{let o=this[s];if(!o)return;let a=o.apply(this,[i]);a instanceof Promise&&(a=await a),l.sendMessages({id:e,data:a})})}triggerSubtitle(t){}async translateSubtitle(t){let s=await this.content.requestSubtitle({url:t._url});if(s){let e;t.responseType=="arraybuffer"?e=new TextEncoder().encode(s).buffer:e=s,Object.defineProperty(t,"responseText",{value:e,writable:!1}),Object.defineProperty(t,"response",{value:e,writable:!1})}}translateSubtitleWithFetch(t){return this.content.requestSubtitle({fetchInfo:t})}async getVideoMeta(t){}isSubtitleRequest(t){return!this.config?.subtitleUrlRegExp||!t?!1:new RegExp(this.config.subtitleUrlRegExp).test(t||"")}};var d=class extends r{timer=null;triggerSubtitle({force:t}){setTimeout(()=>{if(this.config?.subtitleButtonSelector){let s=document.querySelector(this.config.subtitleButtonSelector);if(s){let e=s.getAttribute("aria-pressed")==="true";e&&t?(s.click(),setTimeout(()=>{s.click()},100)):e||s.click();return}}if(this.config?.videoPlayerSelector){let s=document.querySelector(this.config.videoPlayerSelector);s.toggleSubtitles(),setTimeout(()=>{s.toggleSubtitles()},100)}},1e3)}async getVideoMeta(){try{let t=await fetch(globalThis.location.href);if(!t.ok)throw new Error("request subtitle error");let s=await t.text(),i=[...new window.DOMParser().parseFromString(s,"text/html").body.querySelectorAll(":scope > script")].find(o=>o.textContent?.includes("ytInitialPlayerResponse"));return new Function(`const window = {}; ${i?.textContent}; return ytInitialPlayerResponse;`)()}catch{return null}}};var g=class extends r{timer=null;videoMeta={};constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=s=>{let e=t(s);return e&&e.result&&e.result.timedtexttracks&&e.result.movieId&&(this.videoMeta[e.result.movieId]=e.result),e}}getVideoMeta(t){return this.videoMeta[t]}};var f=class extends r{timer=null;videoMeta={};constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=s=>{let e=t(s);return e?.asset?.captions?.length?this.videoMeta[e.id]=e?.asset:e?.previews&&e?.course&&e?.previews?.forEach(i=>{this.videoMeta[i.id]=i}),e}}getVideoMeta(t){return this.videoMeta[t]}};async function R(){let n=await l.sendAsyncMessages({action:"getConfig"});if(!n)return;let s={youtube:d,netflix:g,webvtt:r,khanacademy:r,bilibili:r,udemy:f,general:r}[n.type||""];if(!s)return;let e=new s(n);v(e,n)}m();R();function v(n,t){if(t.hookType==="xhr"){let s=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send,i=function(){return this._url=arguments[1],s.apply(this,arguments)},o=async function(){return n.isSubtitleRequest(this._url)?(await m(),await n.translateSubtitle(this),e.apply(this,arguments)):e.apply(this,arguments)};Object.defineProperty(XMLHttpRequest.prototype,"open",{value:i,writable:!0}),Object.defineProperty(XMLHttpRequest.prototype,"send",{value:o,writable:!0})}else if(t.hookType==="fetch"){let s=globalThis.fetch;globalThis.fetch=async function(e,i){let o=typeof e=="string"?e:e.url||e.href;if(!n.isSubtitleRequest(o))return s(e,i);await m();let y;typeof e=="string"?y={url:e,method:"GET",headers:{}}:y=await x(e);let b=await n.translateSubtitleWithFetch(JSON.stringify({input:y,options:i}));return b?new Response(b):s(e,i)}}}var h=!1;async function m(){return h||(await l.handleMessageOnce("contentReady"),h=!0),h}function x(n){if(n instanceof URL)return{url:n.href,method:"GET",headers:{}};let t={url:n.url,method:n.method,headers:Object.fromEntries(n.headers.entries())};if(n.body)if(n.body instanceof FormData){let s={};for(let[e,i]of n.body.entries())s[e]=i;t.body=s}else return n.text().then(s=>(t.body=s,t));return Promise.resolve(t)}})();
